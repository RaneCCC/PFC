# PFC Beats干涉模拟版本 (数值稳定性修复版)

本版本基于v3_optimization，实现了FFT单分量对六方相的干涉处理，模拟晶粒取向不匹配导致的干涉现象。

## 🔧 数值稳定性修复

**问题诊断**: 原版本在3000-6000步出现NaN值，导致模拟失败。

**修复措施**:
1. **频域更新稳定性**: 添加除零检查，避免`factor2`接近零时的数值爆炸
2. **幅度限制**: 限制频域分量最大幅度为1e6，防止无限增长
3. **初始化检查**: 检测并修正初始状态中的无效值
4. **参数优化**: 减小时间步长(dt=0.005)和干涉强度，提高数值稳定性
5. **温和干涉**: 相位偏移从60°减小到3.75°，避免过度扰动

## 功能说明

这个版本实现了真正的FFT单分量对六方相的干涉处理，通过在频域中对特定区域应用相位调制来产生干涉条纹效果。

## 核心技术实现

### 1. 专用FFT库 (fft_beats.h)

- **fft_2d_beats()**: 带干涉效应的2D FFT
- **相位调制机制**: 对干涉区域的频率分量应用60度相位偏移
- **方向性处理**: 跳过DC分量，只对特定频率范围进行干涉处理

### 2. 干涉掩码生成

```cpp
vector<double> generate_interference_mask(int N)
```

- **空间定位**: 基于晶粒位置和半径确定干涉区域
- **强度计算**: 使用指数衰减函数计算干涉强度
- **方向性因子**: 添加cos(3*(angle-theta))项实现方向性干涉

### 3. 晶粒配置

- **晶粒1** (N/4, N/4, 0°): 无干涉对照组，正常六方相生长
- **晶粒2** (3*N/4, N/4, 60°): 产生干涉，取向60度
- **晶粒3** (N/2, 3*N/4, 120°): 产生干涉，取向120度

## 干涉机制原理

### FFT分量干涉

1. **频域相位调制**: 在fft_2d_beats中对干涉区域应用相位偏移
2. **单分量处理**: 只对psi场使用带干涉的FFT，非线性项使用标准FFT
3. **方向性干涉**: 相位偏移强度与空间位置和晶粒取向相关

### 数学表达

```
phase_shift = π/3 * interference_factor
phase_factor = exp(i * phase_shift)
FFT_component *= phase_factor
```

其中interference_factor由以下因素决定：
- 距离衰减: exp(-dist/(radius*0.8))
- 方向性: 0.5*(1 + cos(3*(angle-theta)))

## 当前状态

✅ **已修复**: NaN值问题已解决，模拟可以完整运行8000步
⚠️ **待优化**: 数值仍然偏大(万级别)，需要进一步调整参数

## 预期效果

### 干涉条纹特征

1. **晶粒1**: 标准六方相，无干涉条纹
2. **晶粒2和3**: 内部出现相间条纹，反映FFT分量与六方相方向的不匹配
3. **条纹方向**: 与晶粒取向和相位偏移方向相关
4. **强度变化**: 从晶粒中心向边缘逐渐减弱

### AMR干扰效应

- 干涉条纹导致晶粒内部密度场剧烈变化
- 高频空间变化对自适应网格细化形成挑战
- 模拟真实情况下的数值计算困难

## 进一步优化建议

1. **参数微调**: 继续减小`A_h`和干涉强度，目标数值范围在[-10, 10]
2. **频率选择**: 优化干涉频率范围，只对特定k值应用相位调制
3. **空间局域化**: 进一步限制干涉区域，避免全局影响
4. **渐进启动**: 在前几百步逐渐增加干涉强度，避免初始冲击

## 编译和运行

```bash
# 编译（需要OpenMP支持）
clang++ -O3 -march=native -ffast-math -funroll-loops -o pfc main.cpp -std=c++17 -fopenmp

# 运行
./pfc
```

## 参数说明

- **steps**: 8001 (适中的模拟步数)
- **frequency**: 1000 (输出频率)
- **晶粒半径**: 12 (稍大以便观察干涉效果)
- **相位偏移**: π/3 (60度，产生明显干涉)

## 输出分析

使用ParaView等可视化工具观察VTK文件：

1. **初始状态** (output_0.vtk): 三个不同取向的六方相晶粒
2. **演化过程** (output_1000.vtk - output_7000.vtk): 干涉条纹逐渐显现
3. **最终状态** (output_8000.vtk): 完全发展的干涉模式

## 技术特点

- **真实物理机制**: 基于FFT频域处理的干涉效应
- **可控参数**: 干涉强度、相位偏移、空间范围可调
- **高性能**: 使用OpenMP并行化，优化编译选项
- **模块化设计**: 专用FFT库便于扩展和修改